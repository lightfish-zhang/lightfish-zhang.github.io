---
layout: post
title: DDIA读书笔记——数据系统的实现基础
date: 2019-03-20 20:30:00 +0800
category: DDIA
tag: [ddia]
thumbnail: 
icon: note
---

* content
{:toc}

## 前言

本文是阅读笔记，记录我对《Designing Data-Intensive Application》的理解，此书简称为DDIA

## 数据密集型系统的定义

现今很多应用程序都是 数据密集型（data-intensive） 的，而非计算密集型（computeintensive） 的。因此CPU很少成为这类应用的瓶颈，更大的问题通常来自数据量、数据复杂
性、以及数据的变更速度。

## 数据系统的衡量标准

为了对事物有更好的认知，先定义标准与衡量方法。以下讲述**如何分析数据系统**的方法论。

### functional requirement 功能需求

**功能需求**：一个应用必须满足各种需求才称得上有用。它应该做什么，比如允许以各种方式存储，检索，搜索和处理数据。

### Reliability 可靠性

**可靠性**：即使发生故障，系统也能正常工作。使用一些容错方式，可以对终端用户隐藏某些类型的故障。

故障可能发生在：

- 硬件（通常是随机的和不相关的）
- 软件（通常是系统性的Bug，很难处理）
- 人类（不可避免地时不时出错）

### Scalability 可扩展性

**可扩展性**：即使在负载增加的情况下也有保持性能的策略。为了讨论可扩展性，我们首先需要定量描述负载和性能的方法。

以推特主页时间线为例子，先描述负载的方法，将响应时间百分位点作为衡量性能的一种方式。在可扩展的系统中可以添加处理容量（processing capacity）以在高负载下保持可靠。


### Maintainability 可维护性

**可维护性**：有许多方面，但实质上是关于工程师和运维团队的生活质量的。良好的抽象可以帮助降低复杂度，并使系统易于修改和适应新的应用场景。良好的可操作性意味着对系统的健康状态具有良好的可见性，并拥有有效的管理手段。


## 数据模型与查询语言

> 在历史上，数据最开始被表示为一棵大树（层次数据模型），但是这不利于表示多对多的关系，所以发明了关系模型来解决这个问题。最近，开发人员发现一些应用程序也不适合采用关系模型，需要采用新的非关系型“NoSQL”数据存储:文档　图形

现今，广泛使用的三种数据模型：**文档、关系、图形**


### 关系模型

基于Edgar Codd在1970年提出的关系模型：数据被组织成关系（SQL中称作表schedule），其中每个关系是元组（SQL中称作行)的无序集合。

关系数据库起源于商业数据处理，典型的事务处理（将销售或银行交易，航空公司预订，库存管理信息记录在库）和批处理（客户发票，工资单，报告）。

关系模型是使用最广泛的数据库模型，典型的代表数据库有：Mysql, Postgresql

### Not Only Sql ——　NoSql

NoSql 是指非关系型数据库，种类非常多，它们常常可以用来处理传统的关系型数据库所难以解决的一系列问题。常用的有：Document，Column Family以及Key-Value Store，本文主要讲述文档与图形

由于现今的数据量每一年都大幅度增加，关系型数据库对一些场景的不适应性越来越明显，于是**文档、图形**类型的数据库进入开发者的技术选项，作为NoSql，它们可以是scheduless的，但两者在关系上的特性是相反的，一个是自我包含，一个是建立节点的图形关系

#### 文档数据库

应用场景是：数据通常是自我包含的，而且文档之间的关系非常稀少。典型代表是 mongodb, elastic search

#### 图形数据库

应用场景：任意事物都可能与任何事物相关联。

人们喜欢把关系型数据库与图形数据库进行对比，举一个突出图形数据库优点的场景：社交应用中，查询一个用户的N度人脉

衡量两者的差异，我们使用这两个指标：**查询路径与性能差距**

- 在描述多对多关系上，关系型数据库需要建立至少两个表（用户表、社交关系表，查询时需要**连接join**）；图形数据库至少需要一个表（用户表），它原生提供**关系**这个功能特性（直接的指针指向）。两者设计上的不同，表现出不同的查询路径：

![](https://cdn.jsdelivr.net/gh/lightfish-zhang/media-library/image/201903/database-diff-relational-graph.png)

- 在性能表现上，摘选 [基于图数据库实现即时推荐引擎](https://zhuanlan.zhihu.com/p/43871070) 的图片

![](https://cdn.jsdelivr.net/gh/lightfish-zhang/media-library/image/201903/database-perf-relational-graph.jpg)

> 在一个拥有百万用户的社交网络中，假设每个人有50个朋友，从A成员出发不断查询朋友节点。传统关系型数据库RDBMS查询到第4个朋友节点时响应时间激增，到第5个时已经不能返回查询结果了。但是图数据库，还具有良好的响应性能。

### 数据模型的小结

这三种模型，并且在各自的领域都发挥很好。一个模型可以用另一个模型来模拟 — 例如，图数据可以在关系数据库中表示 — 但结果往往是糟糕的。这就是为什么我们有着针对不同目的的不同系统，而不是一个单一的万能解决方案。

文档数据库和图数据库有一个共同点，那就是它们通常不会为存储的数据强制一个模式，这可以使应用程序更容易适应不断变化的需求。但是应用程序很可能仍会假定数据具有一定的结构；这只是模式是明确的（写入时强制）还是隐含的（读取时处理）的问题。


## 存储与检索

这一小节是存储与检索，即数据库的最基本功能：当你把数据交给数据库时，它应当把数据存储起来；而后当你向数据库要数据时，它应当把数据返回给你。

数据库如何在内部实现**存储与检索**的功能，不同的方案在实现与优化上存在巨大差异，比如以下由浅入深的角度：

- 数据库，有 RDB 关系型数据库与 NoSql 数据库
- 功能，事务性负载与分析性负载
- 存储引擎的数据结构，日志结构（log-structured）与 面向页面（page-oriented）
- 索引的数据结构：哈希索引、SSTables和LSM树、B树/B+树


### 索引与值

索引与值的存储关系：

- 聚集索引（clustered index），在索引中存储所有行数据
- 非聚集索引（nonclustered index），仅在索引中存储对数据的引用
- 以上两种索引的折衷——包含列的索引（index with included columns）或覆盖索引（covering index）,存储表的一部分在索引内，这允许通过单独使用索引来响应一些查询

行被存储的地方称为堆文件(heap file)，存储的数据没有特定顺序，堆文件方法很常见，因为它避免了在存在多个二级索引时复制数据：每个索引只引用堆文件中的一个位置，实际的数据保存在一个地方。 在不更改键的情况下更新值时，堆文件方法可以非常高效：只要新值不大于旧值，就可以覆盖该记录。如果新值更大，情况会更复杂，因为它可能需要移到堆中有足够空间的新位置。在这种情况下，要么所有的索引都需要更新，以指向记录的新堆位置，或者在旧堆位置留下一个转发指针

在某些情况下，从索引到堆文件的额外跳跃对读取来说性能损失太大，因此可能希望将索引行直接存储在索引中。这被称为聚集索引。例如，在MySQL的InnoDB存储引擎中，表的主键总是一个聚簇索引，二级索引用主键（而不是堆文件中的位置）。在SQL Server中，可以为每个表指定一个聚簇索引。


## 编码格式与演化

程序通常（至少）使用两种形式的数据：

- 在内存中，数据保存在对象，结构体，列表，数组，哈希表，树等中。 这些数据结构针对CPU的高效访问和操作进行了优化（通常使用指针）
- 如果要将数据写入文件，或通过网络发送，则必须将其编码（encode）为某种自包含的字节序列（例如，JSON文档）。 由于每个进程都有自己独立的地址空间，一个进程中的指针对任何其他进程都没有意义，所以这个字节序列表示会与通常在内存中使用的数据结构完全不同

常用术语：

- 从内存中表示到字节序列的转换称为编码（Encoding），也称为序列化（serialization）或编组（marshalling）
- 反过来称为解码（Decoding），解析（Parsing），反序列化（deserialization），反编组() unmarshalling）

### 常用数据格式

- 可读的文本协议：JSON，XML，CSV
- 二进制协议：
    + JSON 的二进制版本：MessagePack，BSON，BJSON，UBJSON，BISON和Smile等
    + 用模式来描述二进制编码格式：Thrift、Protocol Buffers, Apache Avro 

模式描述的二进制编码格式的优点：

Protocol Buffers，Thrift和Avro都使用模式来描述二进制编码格式。他们的模式语言比XML模式或者JSON模式简单得多，它们可以省略编码数据中的字段名称，它支持更详细的验证规则（例如，“该字段的字符串值必须与该正则表达式匹配”或“该字段的整数值必须在0和100之间“）。由于Protocol Buffers，Thrift和Avro实现起来更简单，使用起来也更简单，所以它们已经发展到支持相当广泛的编程语言。


### 数据流的类型

要将某些数据发送到不共享内存的另一个进程，例如，只要您想通过网络发送数据或将其写入文件，就需要将它编码为一个字节序列。对于编码的选型，向前和向后的兼容性是一项重要的指标，对于系统的可演化性非常重要。





## Reference

- [Designing Data-Intensive Application](https://vonng.gitbooks.io/ddia-cn/)
- [基于图数据库实现即时推荐引擎](https://zhuanlan.zhihu.com/p/43871070)
- [图形数据库Neo4J简介](http://www.cnblogs.com/loveis715/p/5277051.html)